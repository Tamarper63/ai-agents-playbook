{% assign pdata = site.data.catalog.policies %}
{% assign pitem = nil %}

{% for section in pdata.catalog %}
  {% for it in section.items %}
    {% if it.url == page.url %}
      {% assign pitem = it %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% if pitem %}
  <div class="c-card" aria-label="Canonical links">
    <div class="c-card__actions" aria-label="Canonical link actions">
      {% if pitem.procedure %}
        <a class="c-btn c-btn--secondary c-btn--compact"
           href="{{ pitem.procedure | relative_url }}"
           title="Open the mapped how-to procedure">
          How-to
        </a>
      {% endif %}

      <a class="c-btn c-btn--secondary c-btn--compact"
         href="{{ '/prompts/' | relative_url }}"
         title="Browse prompt templates">
        Templates
      </a>
    </div>

    {% if pitem.prompts %}
      <div class="c-card__actions" aria-label="Mapped templates">
        <details class="c-disclosure-compact">
          <summary class="c-btn c-btn--secondary c-btn--compact"
                   title="Show the template files mapped to this policy">
            <span class="c-disclosure__label--closed">Templates ({{ pitem.prompts | size }})</span>
            <span class="c-disclosure__label--open">Hide templates</span>
          </summary>

          <div class="c-disclosure-compact__panel">
            <ul class="c-linklist">
              {% for p in pitem.prompts %}
                {% assign fname = p | split: '/' | last %}
                {% assign ftag = 'File' %}
                {% if fname contains '.system.' %}
                  {% assign ftag = 'System' %}
                {% elsif fname contains '.user.' %}
                  {% assign ftag = 'User' %}
                {% endif %}

                <li>
                  <a href="{{ p | relative_url }}" title="Open template file">
                    <span class="c-filetag c-filetag--{{ ftag | downcase }}">{{ ftag }}</span>
                    <code>{{ fname }}</code>
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </details>
      </div>
    {% endif %}
  </div>
{% else %}
  <p><strong>NOT VERIFIED:</strong> this policy is not mapped in <code>docs/_data/catalog/policies.yml</code></p>
{% endif %}