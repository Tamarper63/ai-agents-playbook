{% assign data = site.data.catalog.policies %}

{% for section in data.catalog %}
  {% assign section_id = section.id | default: section.title %}

  <section id="{{ section_id | slugify }}" class="c-section c-section--thin">
    <div class="c-section__header">
      <h3 class="c-section__title c-section__title--sub">{{ section.title }}</h3>
    </div>

    <div class="c-grid {{ section.grid }}">
      {% for item in section.items %}
        <article class="c-card{% if item.span_full %} c-span-full{% endif %}">
          <div class="c-card__title">
            <a class="c-card__link" href="{{ item.url | relative_url }}">{{ item.title }}</a>
          </div>

          {% if item.desc %}<div class="c-card__desc">{{ item.desc }}</div>{% endif %}

          <div class="c-card__actions" aria-label="Policy actions">
            <a class="c-btn c-btn--primary c-btn--compact"
               href="{{ item.url | relative_url }}"
               title="Open the policy page">
              Read policy
            </a>

            {% if item.procedure %}
              <a class="c-btn c-btn--secondary c-btn--compact"
                 href="{{ item.procedure | relative_url }}"
                 title="Open the mapped how-to procedure">
                How-to
              </a>
            {% endif %}

            {% if item.prompts %}
              <details class="c-disclosure-compact">
                <summary class="c-btn c-btn--secondary c-btn--compact"
                         title="Show prompt blocks mapped to this policy">
                  <span class="c-disclosure__label--closed">Prompt blocks ({{ item.prompts | size }})</span>
                  <span class="c-disclosure__label--open">Hide prompt blocks</span>
                </summary>

                <div class="c-disclosure-compact__panel">
                  <ul class="c-linklist">
                    {% for p in item.prompts %}
                      {% assign fname = p | split: '/' | last %}
                      {% assign ftag = 'File' %}
                      {% if fname contains '.system.' %}
                        {% assign ftag = 'System' %}
                      {% elsif fname contains '.user.' %}
                        {% assign ftag = 'User' %}
                      {% endif %}

                      <li>
                        <a href="{{ p | relative_url }}" title="Open prompt block file">
                          <span class="c-filetag c-filetag--{{ ftag | downcase }}">{{ ftag }}</span>
                          <code>{{ fname }}</code>
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </details>
            {% else %}
              <a class="c-btn c-btn--secondary c-btn--compact"
                 href="{{ '/prompts/' | relative_url }}"
                 title="Browse prompt blocks">
                Prompt blocks
              </a>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  </section>
{% endfor %}